# HƯỚNG DẪN TRIỂN KHAI THỦ CÔNG

## Bước 1: Tải code từ Replit về máy

1. Đầu tiên, tải code từ Replit về máy tính bằng cách nhấn vào "⋮" (3 dấu chấm) ở thanh công cụ bên trái, sau đó chọn "Download as zip".

2. Giải nén tệp ZIP vào một thư mục trên máy tính của bạn.

## Bước 2: Chuẩn bị repository GitHub

1. Đăng nhập GitHub và tạo repository mới.

2. Mở terminal/command prompt trên máy tính của bạn, di chuyển vào thư mục code đã giải nén:
   ```bash
   cd đường-dẫn-đến-thư-mục-giải-nén
   ```

3. Khởi tạo Git repository và kết nối với GitHub:
   ```bash
   git init
   git add .
   git commit -m "Initial commit"
   git branch -M main
   git remote add origin https://github.com/username/tên-repository-của-bạn.git
   git push -u origin main
   ```

## Bước 3: Xóa và cập nhật workflow file trên GitHub

1. Trên GitHub, đi đến repository của bạn.

2. **QUAN TRỌNG: Xóa hoàn toàn tất cả các file workflow cũ**:
   - Đi đến `.github/workflows/`
   - Nhấn vào file `build-deploy.yml` 
   - Nhấn vào biểu tượng ba chấm (⋮) ở góc phải
   - Chọn "Delete file" và xác nhận xóa
   - Nếu có các file khác trong thư mục này (như `build-deploy-updated.yml`), cũng xóa chúng

3. Tạo file workflow mới:
   - Đi đến `.github/workflows/`
   - Nhấn vào "Add file" > "Create new file"
   - Đặt tên file là `build-deploy.yml`

3. Xóa toàn bộ nội dung trong tệp và thay thế bằng nội dung sau:

```yaml
name: Build and Deploy (Direct Config)

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        node-version: [18.x]
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Use Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Run type check
      run: npm run check
    
    - name: Generate Firebase Config Directly
      run: |
        cat > public/config.js << 'EOL'
        /**
         * Firebase configuration for production environment
         * Generated by GitHub Actions deployment workflow
         */
        
        window.ENV = {
          // Firebase configuration
          VITE_FIREBASE_PROJECT_ID: "${{ secrets.VITE_FIREBASE_PROJECT_ID }}",
          VITE_FIREBASE_API_KEY: "${{ secrets.VITE_FIREBASE_API_KEY }}",
          VITE_FIREBASE_APP_ID: "${{ secrets.VITE_FIREBASE_APP_ID }}",
          VITE_FIREBASE_MEASUREMENT_ID: "${{ secrets.VITE_FIREBASE_MEASUREMENT_ID }}",
          VITE_FIREBASE_MESSAGING_SENDER_ID: "${{ secrets.VITE_FIREBASE_MESSAGING_SENDER_ID }}",
          VITE_FIREBASE_STORAGE_BUCKET: "${{ secrets.VITE_FIREBASE_PROJECT_ID }}.firebasestorage.app",
          VITE_FIREBASE_DATABASE_URL: "https://${{ secrets.VITE_FIREBASE_PROJECT_ID }}-default-rtdb.asia-southeast1.firebasedatabase.app",
          VITE_FIREBASE_AUTH_DOMAIN: "${{ secrets.VITE_FIREBASE_PROJECT_ID }}.firebaseapp.com",
          
          // API Base URL (không còn sử dụng Firebase Functions)
          VITE_API_BASE_URL: ""
        };
        EOL
        
        echo "Config file created successfully!"
        cat public/config.js
      
    - name: Build application
      run: npm run build
      env:
        VITE_FIREBASE_API_KEY: ${{ secrets.VITE_FIREBASE_API_KEY }}
        VITE_FIREBASE_APP_ID: ${{ secrets.VITE_FIREBASE_APP_ID }}
        VITE_FIREBASE_PROJECT_ID: ${{ secrets.VITE_FIREBASE_PROJECT_ID }}
        VITE_FIREBASE_AUTH_DOMAIN: ${{ secrets.VITE_FIREBASE_PROJECT_ID }}.firebaseapp.com
        VITE_FIREBASE_STORAGE_BUCKET: ${{ secrets.VITE_FIREBASE_PROJECT_ID }}.firebasestorage.app
        VITE_FIREBASE_MESSAGING_SENDER_ID: ${{ secrets.VITE_FIREBASE_MESSAGING_SENDER_ID }}
        VITE_FIREBASE_MEASUREMENT_ID: ${{ secrets.VITE_FIREBASE_MEASUREMENT_ID }}

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: build-files
        path: dist/
        retention-days: 1

  deploy-firebase:
    needs: build
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: build-files
        path: dist/
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18.x'
    
    - name: Install Firebase CLI
      run: npm install -g firebase-tools
    
    - name: Create Firebase Config in dist folder
      run: |
        cat > dist/config.js << 'EOL'
        /**
         * Firebase configuration for production environment
         * Generated by GitHub Actions deployment workflow
         */
        
        window.ENV = {
          // Firebase configuration
          VITE_FIREBASE_PROJECT_ID: "${{ secrets.VITE_FIREBASE_PROJECT_ID }}",
          VITE_FIREBASE_API_KEY: "${{ secrets.VITE_FIREBASE_API_KEY }}",
          VITE_FIREBASE_APP_ID: "${{ secrets.VITE_FIREBASE_APP_ID }}",
          VITE_FIREBASE_MEASUREMENT_ID: "${{ secrets.VITE_FIREBASE_MEASUREMENT_ID }}",
          VITE_FIREBASE_MESSAGING_SENDER_ID: "${{ secrets.VITE_FIREBASE_MESSAGING_SENDER_ID }}",
          VITE_FIREBASE_STORAGE_BUCKET: "${{ secrets.VITE_FIREBASE_PROJECT_ID }}.firebasestorage.app",
          VITE_FIREBASE_DATABASE_URL: "https://${{ secrets.VITE_FIREBASE_PROJECT_ID }}-default-rtdb.asia-southeast1.firebasedatabase.app",
          VITE_FIREBASE_AUTH_DOMAIN: "${{ secrets.VITE_FIREBASE_PROJECT_ID }}.firebaseapp.com",
          
          // API Base URL (không còn sử dụng Firebase Functions)
          VITE_API_BASE_URL: ""
        };
        EOL
        
        echo "Config file created successfully in dist folder!"
        cat dist/config.js
        
    - name: Prepare dist structure for Firebase
      run: |
        mkdir -p dist/public
        cp -r dist/* dist/public/ 2>/dev/null || :
        rm -rf dist/public/public || :
        
        # Verify structure
        echo "Dist folder structure prepared for Firebase deployment"
        ls -la dist
        ls -la dist/public
        
    - name: Deploy to Firebase
      run: firebase deploy --only hosting --project ${{ secrets.VITE_FIREBASE_PROJECT_ID }}
      env:
        FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN }}
```

4. Nhấn "Commit changes" để lưu thay đổi.

## Bước 4: Thiết lập GitHub Secrets

1. Trong GitHub repository, đi đến "Settings" > "Secrets and variables" > "Actions".

2. Nhấn "New repository secret" và thêm các thông tin sau từ Firebase Console:
   - `FIREBASE_TOKEN` (lấy bằng lệnh `firebase login:ci` trên máy của bạn)
   - `VITE_FIREBASE_API_KEY`
   - `VITE_FIREBASE_APP_ID` 
   - `VITE_FIREBASE_PROJECT_ID`
   - `VITE_FIREBASE_MESSAGING_SENDER_ID`
   - `VITE_FIREBASE_MEASUREMENT_ID`

## Bước 5: Chạy Workflow

1. Đi đến tab "Actions" trong GitHub repository.

2. Bạn sẽ thấy workflow "Build and Deploy (Direct Config)" đang chạy hoặc đang chờ.

3. Nếu workflow không tự động chạy, nhấn vào "Run workflow" và chọn branch "main" để kích hoạt thủ công.

## Lưu ý quan trọng

- **PHẢI XÓA TẤT CẢ CÁC FILE WORKFLOW CŨ** trước khi thêm file mới, nếu không sẽ tiếp tục gặp lỗi "Cannot find module".
- Đảm bảo bạn đã tạo Firebase project và cấu hình đúng Firebase Hosting.
- Tệp firebase.json phải đúng và có cấu hình hosting chỉ đến `dist/public`.
- **KHÔNG SỬ DỤNG** script `scripts/prepare-github-deploy.js` trong workflow mới. Workflow mới đã được cấu hình để tạo file config.js trực tiếp bằng bash.
- Khi gặp lỗi, luôn kiểm tra logs trong tab Actions trên GitHub để phát hiện vấn đề.

## Xác minh triển khai thành công

Sau khi workflow chạy xong, để xác nhận triển khai đã thành công:

1. Kiểm tra URL triển khai Firebase (thường có dạng https://your-project-id.web.app)
2. Đảm bảo trang web được tải mà không hiển thị lỗi "Firebase: Error (auth/api-key-not-valid)"
3. Kiểm tra kỹ chức năng đăng nhập và tải dữ liệu

## Xử lý sự cố

- **Lỗi "Cannot find module"**: Xóa tất cả các workflow cũ và tạo workflow mới theo hướng dẫn.
- **Lỗi "API key not valid"**: Kiểm tra lại các secrets trên GitHub và đảm bảo config.js đã được tạo đúng.
- **Lỗi CORS**: Đảm bảo bạn đã cấu hình đúng Firebase Storage Rules.