TASK: Kiểm tra & sửa 2 tính năng Firestore (Goals, Strategies) – production-ready

Bối cảnh

App dùng Firebase (Auth + Firestore).

Ảnh chart được auto-capture bằng API riêng; không liên quan trực tiếp task này.

Lỗi hiện tại:

Goals: không tạo được goal mới (cần đồng bộ đúng userId, tạo/đọc/cập nhật milestones ổn định).

Strategy: tạo strategy mới mà có rules/entryConditions/exitConditions thì không lưu được; nếu không thêm các mảng này thì lại lưu được.

Yêu cầu sửa

Goals

Sửa addGoal, getGoals, getGoalById, updateGoal, deleteGoal, addMilestone, getMilestones, updateMilestone, deleteMilestone để:

Luôn ghi/đọc theo path: users/{userId}/goals và users/{userId}/goals/{goalId}/milestones.

Chuẩn hoá kiểu ngày: nếu input là Date → convert Timestamp.fromDate; nếu đã là Timestamp thì giữ nguyên; khi update dùng serverTimestamp() cho updatedAt.

Khi getGoals/getGoalById, trả về object tuân theo interface (nhất là Milestone.currentValue, targetType, completedDate có thể null).

Đảm bảo userId được set trong document goal (field) ngay lúc tạo để queries/analytics dùng.

Milestones phải đồng bộ với goal (khi xóa goal → xóa toàn bộ milestones bằng batch).

Strategies

Sửa addStrategy, updateStrategy, getStrategyById, getStrategies, onStrategiesSnapshot để:

Path: users/{userId}/strategies.

Khi tạo hoặc cập nhật:

Cho phép các mảng rules, entryConditions, exitConditions là mảng các object theo StrategyCondition (id, label, indicator?, timeframe?, expectedValue?, description?, order).

Nếu UI gửi chuỗi/array trống → lưu mảng rỗng thay vì undefined.

Với mỗi phần tử, nếu thiếu id → tự tạo rule-xxxx, entry-xxxx, exit-xxxx.

Không ném lỗi nếu một số field optional không có (chỉ cần id, label, order có kiểu hợp lệ).

Khi update:

Xoá id top-level trước khi updateDoc, set updatedAt = serverTimestamp().

Không xoá nhầm toàn bộ mảng vì “undefined”; chỉ xoá key nào explicit undefined.

Khi get: map về đúng interface TradingStrategy (mảng có thể rỗng; không crash vì thiếu field).

File/điểm cần xem & sửa

client/src/lib/firebase-service.ts (hoặc file dịch vụ Firebase bạn đang dùng):

addGoal, getGoals, getGoalById, updateGoal, deleteGoal, addMilestone, getMilestones, updateMilestone, deleteMilestone, deleteMilestonesForGoal.

addStrategy, updateStrategy, getStrategies, getStrategyById, onStrategiesSnapshot.

client/src/types.ts (đảm bảo interface Goal, Milestone, TradingStrategy, StrategyCondition khớp với data thực tế).

Chỗ Form submit của Goal/Strategy (nếu có) – đảm bảo truyền userId hợp lệ và normalize dữ liệu trước khi call service.

Triệu chứng/hypothesis

Goals fail: do không convert Date ↔ Timestamp, thiếu userId trong doc, hoặc missing subcollection path chuẩn.

Strategies fail khi có mảng: do undefined fields bị updateDoc reject, hoặc attempt set object với thuộc tính không serializable, hoặc không map mảng thành plain objects/thiếu id/order.

Cụ thể cần code-fix

Trong addGoal:

Normalize startDate/endDate sang Timestamp nếu là Date.

Set userId, createdAt=serverTimestamp(), updatedAt=serverTimestamp().

Trong updateGoal:

Không gửi milestones trong payload; luôn set updatedAt=serverTimestamp().

Trong addMilestone/updateMilestone:

Convert completedDate nếu là Date.

Trong getGoals/getGoalById/getMilestones:

Trả về đúng shape, bao gồm id, goalId, các field optional mặc định hợp lý (ví dụ currentValue: 0, isCompleted: false).

Trong addStrategy:

Làm sạch strategyData, đảm bảo rules/entryConditions/exitConditions là mảng object “serializable”, thêm id nếu thiếu, ép order là number.

Set createdAt=serverTimestamp().

Trong updateStrategy:

Xoá id top-level, set updatedAt=serverTimestamp().

Với từng mảng, map lại phần tử cho đúng schema; không pass undefined.

Không xoá field nếu UI không gửi (tránh overwrite thành undefined).

Trong mọi get*:

Cast dữ liệu về đúng interface; fallback giá trị rỗng cho mảng.

Kiểm thử (Replit chạy local hoặc preview)

Goals

Tạo goal mới (có startDate/endDate là Date) → tạo OK, doc path users/{uid}/goals/{id}, field userId tồn tại, timestamps set.

Thêm milestones (1–2 cái) → tạo OK, đọc lại goal có danh sách milestones đúng thứ tự createdAt asc.

Sửa goal (chỉ đổi title) → không mất milestones, updatedAt đổi.

Xoá goal → milestones trong subcollection bị xoá bằng batch.

Strategies

Tạo strategy có 3 mảng rules/entryConditions/exitConditions, mỗi mảng 1–2 phần tử (có phần tử thiếu id & một số optional) → lưu OK, đọc lại đủ mảng.

Cập nhật strategy: thêm 1 rule, đổi order, đổi label → cập nhật OK; updatedAt đổi; không crash vì undefined.

Tạo strategy không có mảng → lưu OK (mảng mặc định rỗng).

Check console:

Không còn lỗi của Firestore về “invalid data”/“unsupported field value undefined”.

Không còn lỗi serializing kiểu Date trực tiếp (mọi ngày đã convert).

Chú ý production

Dùng đúng import { Timestamp, serverTimestamp } from 'firebase/firestore'.

Không bao giờ ghi Date trực tiếp vào Firestore.

Trước khi updateDoc, xoá id top-level của object.

Mọi mảng field phải là plain JSON (không function, không class).

Thêm logging gọn: trước/ sau add/update, in ra payload đã normalize.

Acceptance criteria

Tạo goal mới + milestones thành công; đọc/ update/ delete không lỗi.

Tạo strategy có mảng điều kiện thành công; update thêm/sửa điều kiện thành công.

Không lỗi ở production build.